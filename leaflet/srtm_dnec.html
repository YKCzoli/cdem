<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="cdem/DNEC 50k Tile Grabber">
  <meta name="author" content="Vincent Sarago">

  <title>cdem/DNEC 50k Tile Grabber</title>

  <!-- Bootstrap Core CSS -->
  <link href="css/bootstrap.min.css" rel="stylesheet">

  <!-- leaflet CSS -->
  <link href="css/leaflet.css" rel="stylesheet">
</head>

<style>
  body {
    padding: 0;
    margin: 0;
  }

  html,
  body,
  #map {
    height: 100%;
  }
</style>

<body>
  <div id="map"></div>
  <!-- jQuery -->
  <script src="js/jquery.js"></script>
  <!-- Leaflet -->
  <script src="js/leaflet.js"></script>
  <script src="js/leaflet.spin.js"></script>
  <!-- spin -->
  <script src="js/spin.min.js"></script>
  <!-- d3 -->
  <script src="js/d3.min.js"></script>
  <!-- queue -->
  <script src="js/queue.min.js"></script>
  <!-- topojson -->
  <script src="js/topojson.min.js"></script>
  <!-- Bootstrap Core JavaScript -->
  <script src="js/bootstrap.min.js"></script>

  <script>

    var flyToZoom = {
      "Northwest Territories": 4,
      "Nunavut": 4,
      "New Brunswick": 6,
      "Nova Scotia": 6,
      "Prince Edward Island": 8
    }

    function onEachFeature(feature, layer) {
      var mirror = 'http://ftp.geogratis.gc.ca/pub/nrcan_rncan/elevation/geobase_cded_dnec/';
      var data_dir = '50k_dem/'
      var img_dir = 'images_50k/'
      var name = feature.properties.NUMFEUILLE;

      var dir = name.slice(0, 3)
      var file = mirror + data_dir + dir + '/' + name.toLowerCase() + '.zip'
      var quicklook = mirror + img_dir + 'dnec_' + name.toLowerCase() + '.jpg'

      var html = '<div id="pop">' +
        '    You clicked tile <strong>' + name + '</strong>!<br>' +
        '    <img id="quicklook" src="' + quicklook + '" class="img-thumbnail" width="200" height="200">' +
        '    <div>' +
        '         <a id="tip_button" class="btn btn-small btn-success tip_button" href="' + file + '" target="_blank">Download DNEC Tile</a><br>' +
        '    </div>' +
        '</div>';
      var popup = L.popup({
          maxWidth: 512,
          maxHeight: 512
        })
        .setContent(html);
      layer.bindPopup(popup);
    };

    function onEachProvTerr(feature, layer) {
      layer.on('click', function(){
        map.flyTo(layer.getBounds().getCenter(), (flyToZoom[feature.properties.name] || 5));
      })
    }

    bounds = L.latLngBounds([39, -142], [84, -52]);

    var map = L.map('map', {
      center: [60, -95],
      zoom: 4,
      minZoom: 3,
      maxZoom: 12
    });

    map.spin(true);
    var osm_url = 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
    var attribution_osm = '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>';
    var OpenStreetMap = L.tileLayer(osm_url, {
        id: 'MapID',
        attribution: attribution_osm
      })
      .addTo(map);

    var opentopomap_url = 'https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png';
    var attribution_opentopomap = 'Map data: &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>, <a href="http://viewfinderpanoramas.org">SRTM</a> | Map style: &copy; <a href="https://opentopomap.org">OpenTopoMap</a> (<a href="https://creativecommons.org/licenses/by-sa/3.0/">CC-BY-SA</a>)'
    var OpenTopoMap = L.tileLayer(opentopomap_url, {
      attribution: attribution_opentopomap
    });

    var osm_blackwhite_url = 'http://{s}.tiles.wmflabs.org/bw-mapnik/{z}/{x}/{y}.png';
    var OpenStreetMap_BlackAndWhite = L.tileLayer(osm_blackwhite_url, {
      attribution: attribution_osm
    });

    var esri_worldimagery_url = 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}';
    var attribution_esriworldimagery = 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
    var Esri_WorldImagery = L.tileLayer(esri_worldimagery_url, {
      attribution: attribution_esriworldimagery
    });

    var cdem_url = 'http://maps.geogratis.gc.ca/wms/elevation_en?';
    var attribution_cdem = '<a href="http://open.canada.ca/en/open-government-licence-canada">Open Government Licence - Canada</a>';
    var cdem = L.tileLayer.wms(cdem_url, {
      id: 'MapID',
      attribution: attribution_cdem,
      layers: 'cdem.color-shaded-relief',
      transparent: true,
      format: 'image/png'
    }).addTo(map);

    var dnecPolyOptions = {
      "color": "#1C1C1C",
      "weight": 0.2,
      "fillOpacity": 0.1
    };

    var provterrPolyOptions = {
      "color": "#1C1C1C",
      "weight": 0.4,
      "fillOpacity": 0.0
    };

    topo_dnec = L.geoJson(null, {
      style: dnecPolyOptions,
      onEachFeature: onEachFeature
    });

    topo_provterr = L.geoJson(null, {
      style: provterrPolyOptions,
      onEachFeature: onEachProvTerr
    });

    queue()
      .defer(d3.json, 'data/dnec.json')
      .defer(d3.json, 'data/provterrito_topo.json')
      .await(addToMap);

    function addToMap(error, dnec, provterr) {
      var dnec_layer = topojson.object(dnec, dnec.objects.dnec).geometries;
      topo_dnec.addData(dnec_layer);
      // topo_dnec.addTo(map);
      var provterr_layer = topojson.object(provterr, provterr.objects.provterrNEAdmin1).geometries;
      topo_provterr.addData(provterr_layer);
      topo_provterr.addTo(map);
      map.spin(false);
    }

    var baseMaps = {
      "OpenStreetMap": OpenStreetMap,
      "OpenStreetMap: Black & White": OpenStreetMap_BlackAndWhite,
      "OpenTopoMap": OpenTopoMap,
      "Esri World Imagery": Esri_WorldImagery
    };

    var overlayMaps = {
      "CDEC/DNEC Grid": topo_dnec,
      "Provinces and Territories": topo_provterr,
      "Canadian Digital Elevation Relief": cdem,
    };

    L.control.layers(baseMaps, overlayMaps).addTo(map);
  </script>
</body>

</html>
